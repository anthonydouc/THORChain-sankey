<html>

<head>
    <title>Thorswap Sankey</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <script src="https://kit.fontawesome.com/3793da8bd7.js" crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <style>
        html {
            background-color: #22242a;
        }

        .google-visualization-tooltip {
            background-color: #22242a !important;
            border: 0px solid #22242a !important;
            -webkit-box-shadow: 0px 0px 0px 0px !important;
        }

        ul,
        li,
        p,
        strong {
            color: white !important;
        }

        select {
            color: white !important;
            background-color: #22242a !important;
        }


        .social-text {
            color: #28dcf7 !important;
            font-weight: 700;
        }

        a.social-link:link,
        :visited {
            color: #28dcf7;
        }

        a.social-link:hover {
            color: #28dcf7;
            text-decoration: underline;
        }
    </style>


    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['sankey'] });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {

            var json = $.ajax({
                url: "https://api.flipsidecrypto.com/api/v2/queries/18af3d33-c935-4148-9f4f-f30c28d3dcfb/data/latest",
                dataType: "json",
                success: function (jsonData) {
                    var data = new google.visualization.DataTable();
                    var selected_asset = document.getElementById("selected_asset").value;
                    var direction = document.getElementById("direction").value;
                    var volume_type = document.getElementById("volume_type").value;
                    var include_synths = document.getElementById("include_synths").value;

                    data.addColumn('string', "FROM");
                    data.addColumn('string', "TO");
                    data.addColumn('number', "WEIGHT");
                    data.addColumn({ type: 'string', role: 'tooltip' });

                    var amounts = [];
                    var included = [];
                    var tooltips = [];

                    // first determine which entries are included based on selected filters.
                    for (var i = 0; i < jsonData.length; i++) {
                        from = jsonData[i].FROM_ASSET;
                        to = jsonData[i].TO_ASSET;
                        from_type = jsonData[i].FROM_TYPE;
                        to_type = jsonData[i].TO_TYPE;

                        var include = false;
                        var asset_received = (from != selected_asset) && (to == selected_asset);
                        var asset_offered = (from == selected_asset) && (to != selected_asset);

                        var inc_synths = (include_synths == 'Assets & Synths') || (include_synths == 'Synths only')
                        var inc_assets = (include_synths == 'Assets & Synths') || (include_synths == 'Assets only')

                        var offered_type_inc = ((to_type == 'synth') && inc_synths) || ((to_type == 'asset') & inc_assets);

                        var received_type_inc = ((from_type == 'synth') && inc_synths) || (from_type == 'asset' & inc_assets);

                        if ((direction == "Received") && asset_received && received_type_inc) {
                            include = true
                        }
                        else if ((direction == "Offered") && asset_offered && offered_type_inc) {
                            include = true
                        }

                        if (include) {
                            amounts.push(parseFloat(jsonData[i].AMOUNT))
                            included.push(true)
                        }
                        else {
                            included.push(false)
                        };

                    };

                    // calculate maximum value of selected entries. This is used to enforce a minimum weight on very small entries.
                    max = Math.max(...amounts);

                    for (var i = 0; i < jsonData.length; i++) {
                        if (included[i]) {

                            from = jsonData[i].FROM_ASSET;
                            to = jsonData[i].TO_ASSET;
                            from_type = jsonData[i].FROM_TYPE;
                            to_type = jsonData[i].TO_TYPE;

                            if (volume_type == 'Total USD volume') {
                                amount = jsonData[i].AMOUNT;
                                amount_currency = Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumSignificantDigits: 12 }).format(amount)
                            }
                            else if (volume_type == 'Total RUNE volume') {
                                amount = jsonData[i].AMOUNT_RUNE;
                                amount_currency = Intl.NumberFormat('en-US', { maximumSignificantDigits: 12 }).format(amount)
                            }

                            tooltip = '<div style="margin: 5px;"><p style=" width:150px;"><strong>' + from + '</strong> to <strong>' + to + '</strong></p><span style="color:#ffffff">' + volume_type + ': ' + amount_currency + '</span></div>';
                            
                            data.addRow([from, to, Math.max(max * 0.001, amount), tooltip]);
                        };
                    };

                    // Sets chart options.
                    var options = {
                        tooltip: { isHtml: true },
                        sankey: {
                            iterations: 2,
                            link: {
                                colorMode: 'gradient',
                                color: { stroke: '#00deff', strokeWidth: 0.05 }
                            },
                            node: {
                                width: 20,
                                nodePadding: 12,
                                label: {
                                    color: '#FFFFFF'
                                }
                            }
                        },
                    };

                    // Instantiates and draws our chart, passing in some options.
                    var chart = new google.visualization.Sankey(document.getElementById('sankey_from'));
                    chart.draw(data, options);
                }
            });
        }

        window.onload = (function () {
            var json = $.ajax({
                url: "https://api.flipsidecrypto.com/api/v2/queries/044ea8ff-9093-49d2-b440-045ea4a83597/data/latest",
                dataType: "json",
                success: function (jsonData) {
                    options = jsonData[0]['ASSETS'].split(',')

                    select = document.getElementById("selected_asset");
                    for (var i = 0; i <= options.length - 1; i++) {
                        option = document.createElement("option");
                        option.innerHTML = options[i];
                        select.appendChild(option);
                    }
                }
            });

        });

    </script>
</head>

<body>
    <div class="container is-fullhd">

        <div class="block mt-2 mb-3">
            <p class="title is-2">Thorchain swap <span style="color:#28dcf7" ;>Sankey</span></p>
            <p class="subtitle is-4"><span style="color:#28dcf7" ;>An interactive tool for visualising aggregated
                    Thorchain swap
                    volume</span></p>
        </div>
        <div class="block mt-4 mb-6">
            <div class="columns">
                <div class="column is-one-fifth">
                    <p class=" ml-1 mb-2 is-title-5">Choose an asset or synth:</p>
                    <div class="select is-rounded is-info">
                        <select style="width:200px;" id="selected_asset" onchange="drawChart()">
                        </select>
                    </div>
                </div>
                <div class="column is-one-fifth">
                    <p class=" ml-1 mb-2 is-title-5">Choose the swap direction:</p>
                    <div class="select is-rounded is-info">
                        <select style="width:200px;" id="direction" onchange="drawChart()">
                            <option>Offered</option>
                            <option>Received</option>
                        </select>
                    </div>
                </div>
                <div class="column is-one-fifth">
                    <p class=" ml-1 mb-2 is-title-5">Include synths?:</p>
                    <div class="select is-rounded is-info">
                        <select style="width:200px;" id="include_synths" onchange="drawChart()">
                            <option>Assets & Synths</option>
                            <option>Assets only</option>
                            <option>Synths only</option>
                        </select>
                    </div>
                </div>
                <div class="column is-one-fifth">
                    <p class=" ml-1 mb-2 is-title-5">Choose the volume units:</p>
                    <div class="select is-rounded is-info">
                        <select style="width:200px;" id="volume_type" onchange="drawChart()">
                            <option>Total RUNE volume</option>
                            <option>Total USD volume</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="block">
            <div id="sankey_from" style="width: 100%; height: 90%;"> </div>
        </div>

        <div class="block mt-4">
            <p class="title is-4">Technical notes</p>
            <div class="content">
                <ul>
                    <li>
                        <p>Swap volume represents the total USD or RUNE value of all swaps between pairs of tokens, for
                            all
                            data
                            available in Flipside Crypto's Thorchain swaps table.</p>
                    </li>
                    <li>
                        <p>Swaps between two tokens (excluding RUNE) involve trading the first token for RUNE, then
                            from
                            RUNE to the second token. The intermediate swap is not visualised for clarity.</p>
                    </li>
                </ul>
                <p>A JSON enpoint for the underlying data is available: <a class="social-link"
                        href="https://api.flipsidecrypto.com/api/v2/queries/18af3d33-c935-4148-9f4f-f30c28d3dcfb/data/latest"
                        target="_blank">here</a>.
                    The entire web application is publically available as <a class="social-link"
                        href="https://github.com/anthonydouc/Thorswap-sankey" target="_blank">a public github
                        repository</a>.</p>
            </div>
        </div>

        <div class="block mb-1">
            <span class="social-text">AD</span>
            <a class="social-link" href="https://stackoverflow.com/users/7583832/anthonydouc" target="_blank">
                <i class="fab fa-stack-overflow fa-lg social-link" aria-hidden="true"></i>
            </a>
            <a class="social-link" href="https://github.com/anthonydouc" target="_blank">
                <i class="fab fa-github fa-lg social-link" aria-hidden="true"></i>
            </a>
            <a class="social-link" href="https://twitter.com/AD14367367" target="_blank">
                <i class="fab fa-twitter fa-lg social-link" aria-hidden="true"></i>
            </a>
        </div>
    </div>

</body>

</html>